name: Real-time 4D Scraper

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "è½®æ¬¡: $i - æ­£åœ¨å°è¯•å…¬å…±æ•°æ®æºåŒæ­¥..."
            
            # ä½¿ç”¨å…¬å…± API æŠ“å–å¤§é©¬å½© (dmc) æ•°æ®
            # è¿™ä¸ªæ¥å£ä¸“é—¨ç»™å¼€å‘è€…ç”¨ï¼Œä¸ä¼šå°é” GitHub
            curl -sL "https://api.4dking.com.my/v1/results?company=dmc" \
              -o raw.json

            # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
            if grep -q "draw_no" raw.json; then
               # å°†ç¬¬ä¸‰æ–¹æ ¼å¼è½¬æ¢ä¸ºä½ çš„ç½‘é¡µèƒ½è¯†åˆ«çš„æ ¼å¼
               # æå–æœŸå·ã€é¦–å¥–ã€äºŒå¥–ã€ä¸‰å¥–
               DRAWNO=$(grep -oP '(?<="draw_no":")[^"]+' raw.json | head -1)
               P1=$(grep -oP '(?<="p1":")[^"]+' raw.json | head -1)
               P2=$(grep -oP '(?<="p2":")[^"]+' raw.json | head -1)
               P3=$(grep -oP '(?<="p3":")[^"]+' raw.json | head -1)
               
               echo "{\"drawNo\":\"$DRAWNO\", \"p1\":\"$P1\", \"p2\":\"$P2\", \"p3\":\"$P3\"}" > data.json
               echo "âœ… æˆåŠŸ! æœŸå·: $DRAWNO å·ç : $P1, $P2, $P3"
               
               git add data.json
               if git commit -m "Live Update: $DRAWNO"; then
                 git push
                 echo "ğŸš€ å·²æ¨é€åˆ°ç½‘é¡µ"
               else
                 echo "ğŸ˜´ æ— å˜åŠ¨"
               fi
            else
               echo "âš ï¸ ç¬¬ä¸‰æ–¹æ¥å£æš‚æ— å“åº”ï¼Œå°è¯•å¤‡ç”¨ç½‘é¡µæŠ“å–..."
               # å¤‡ç”¨ï¼šæŠ“å–ä¸€ä¸ªèšåˆå¼€å¥–ç«™
               curl -sL "https://4dresult.com/damacai" -o temp.html
               P1=$(grep -A 2 "1st Prize" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
               echo "{\"drawNo\":\"Today\", \"p1\":\"$P1\", \"p2\":\"----\", \"p3\":\"----\"}" > data.json
            fi
            
            sleep 60
          done
