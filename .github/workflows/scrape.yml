name: Real-time 4D Scraper

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "轮次: $i - 正在从聚合平台同步..."
            
            # 抓取一个非常稳定的第三方开奖聚合页 (这个站对爬虫很友好)
            curl -sL "https://www.4dscore.com/damacai-1-3d" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
              -o temp.html

            # 精准提取：4dscore 的结构比较固定
            # 我们找包含 "1st Prize" 后的第一个 4 位数字
            P1=$(grep -A 5 "1st Prize" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
            P2=$(grep -A 5 "2nd Prize" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
            P3=$(grep -A 5 "3rd Prize" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
            DRAWNO=$(grep -oE '[0-9]{4}/[0-9]{2}' temp.html | head -1 || echo "Live")

            # 写入数据
            echo "{\"drawNo\":\"$DRAWNO\", \"p1\":\"$P1\", \"p2\":\"$P2\", \"p3\":\"$P3\"}" > data.json
            echo "当前数据 -> 期号: $DRAWNO | 首奖: $P1 | 二奖: $P2 | 三奖: $P3"

            # 检查是否有号码（不是 ---- 且不是空的）
            if [ "$P1" != "----" ] && [ -n "$P1" ]; then
              git add data.json
              if git commit -m "Auto Update: $DRAWNO"; then
                git push
                echo "✅ 同步成功！"
              else
                echo "😴 号码没变。"
              fi
            else
              echo "⚠️ 暂未发现有效号码，正在等待官网更新..."
            fi
            
            sleep 60
          done
