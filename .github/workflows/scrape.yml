name: Real-time 4D Scraper

on:
  schedule:
    # æ¯å¤©é©¬æ—¶é—´ 19:00 å¯åŠ¨ (UTC 11:00)
    - cron: '0 11 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»èµ‹äºˆå†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³•æ›´æ–° data.json
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "æ­£åœ¨åŒæ­¥å®æ—¶å¼€å¥– - è½®æ¬¡: $i - $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
            
            # æŠ“å–æ•°æ®
            # ä½¿ç”¨ -sL ç¡®ä¿é™é»˜æŠ“å–å¹¶è‡ªåŠ¨è·Ÿéšé‡å®šå‘
            curl -sL "https://livedraw.damacai.com.my/DrawResult.json" > data.json
            
            # æ£€æŸ¥æŠ“åˆ°çš„æ•°æ®æ˜¯å¦åŒ…å«å…³é”®å­—æ®µ "drawNo" æˆ– "DrawNo" (å¿½ç•¥å¤§å°å†™)
            if grep -qi "drawNo" data.json; then
              git add data.json
              # åªæœ‰å½“æ–‡ä»¶å†…å®¹çœŸçš„å‘ç”Ÿå˜åŒ–æ—¶æ‰æäº¤
              if git commit -m "Live Update: $(date -d '+8 hours' '+%H:%M:%S')"; then
                git push
                echo "âœ… å‘ç°æ–°å·ç ï¼Œå·²åŒæ­¥åˆ°ä»“åº“ï¼"
              else
                echo "ğŸ˜´ æ•°æ®æœªå˜åŒ–ï¼Œæ— éœ€æ›´æ–°ã€‚"
              fi
            else
              echo "âš ï¸ æ¥å£å°šæœªè¿”å›æœ‰æ•ˆæ•°æ® (å½“å‰æŠ“å–å†…å®¹: $(head -c 50 data.json)...)"
            fi
            
            echo "ç­‰å¾… 60 ç§’..."
            sleep 60
          done
