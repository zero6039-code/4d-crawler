name: Real-time 4D Scraper

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "è½®æ¬¡: $i - æ­£åœ¨æ·±åº¦æ‰«æç½‘é¡µå·ç ..."
            
            # æŠ“å–é¦–é¡µæºç 
            curl -sL "https://www.damacai.com.my/" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
              -o temp.html

            # --- å¼ºåŠ›æå–é€»è¾‘ ---
            # æ‰¾åŒ…å« p1-number çš„è¡ŒåŠå…¶å 10 è¡Œï¼Œæå–å‡º 4 ä½æ•°å­—
            P1=$(grep -A 10 "p1-number" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
            P2=$(grep -A 10 "p2-number" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
            P3=$(grep -A 10 "p3-number" temp.html | grep -oE '[0-9]{4}' | head -1 || echo "----")
            
            # æå–æœŸå· (ç±»ä¼¼ 5801/26)
            DRAWNO=$(grep -oE '[0-9]{4}/[0-9]{2}' temp.html | head -1 || echo "Pending")

            # ç”Ÿæˆ JSON
            echo "{\"drawNo\":\"$DRAWNO\", \"p1\":\"$P1\", \"p2\":\"$P2\", \"p3\":\"$P3\"}" > data.json
            
            echo "æŠ“å–æˆåŠŸ -> æœŸå·: $DRAWNO | é¦–å¥–: $P1 | äºŒå¥–: $P2 | ä¸‰å¥–: $P3"

            # æäº¤å¹¶æ¨é€
            git add data.json
            if git commit -m "Live Update: $DRAWNO ($i)"; then
              git push
              echo "âœ… æ•°æ®å·²æ¨é€åˆ° GitHub Pagesï¼"
            else
              echo "ğŸ˜´ æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æœ¬æ¬¡æ¨é€ã€‚"
            fi
            
            sleep 60
          done
