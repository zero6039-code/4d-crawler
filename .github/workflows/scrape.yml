name: Real-time 4D Scraper

on:
  schedule:
    # æ¯å¤©é©¬æ—¶é—´ 19:00 å¯åŠ¨ (UTC 11:00)
    - cron: '0 11 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆå†™å…¥æƒé™ä»¥æ›´æ–° data.json
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "æ­£åœ¨åŒæ­¥å®æ—¶å¼€å¥– - è½®æ¬¡: $i - $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
            
            # å¼ºåŒ–æŠ“å–ï¼šåŠ å…¥ Referer å’Œ User-Agent ä¼ªè£…æµè§ˆå™¨
            curl -sL "https://livedraw.damacai.com.my/DrawResult.json" \
              -H "Referer: https://livedraw.damacai.com.my/" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -o data.json
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸæŠ“å–åˆ°åŒ…å« drawNo çš„ JSON æ•°æ®
            if grep -qi "drawNo" data.json; then
              git add data.json
              # åªæœ‰å†…å®¹å˜åŒ–ï¼ˆäº§ç”Ÿæ–°å·ç ï¼‰æ—¶æ‰æ¨é€
              if git commit -m "Live Update: $(date -d '+8 hours' '+%H:%M:%S')"; then
                git push
                echo "âœ… å‘ç°æ–°å·ç ï¼Œç½‘é¡µå·²åŒæ­¥ï¼"
              else
                echo "ğŸ˜´ æ•°æ®æš‚æ— å˜åŒ–ã€‚"
              fi
            else
              echo "âš ï¸ æŠ“å–å†…å®¹æ— æ•ˆã€‚å‰50å­—ç¬¦: $(head -c 50 data.json)"
              echo "æç¤ºï¼šå¦‚æœä¾ç„¶æ˜¾ç¤º Resource removedï¼Œè¯·æ£€æŸ¥æ¥å£é“¾æ¥æ˜¯å¦å¤±æ•ˆã€‚"
            fi
            
            echo "ç­‰å¾… 60 ç§’è¿›è¡Œä¸‹è½®æŠ“å–..."
            sleep 60
          done
