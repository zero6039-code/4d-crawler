name: Real-time 4D Scraper

on:
  schedule:
    # æ¯å¤©é©¬æ—¶é—´ 19:00 å¯åŠ¨ (UTC 11:00)
    - cron: '0 11 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "æ­£åœ¨åŒæ­¥å®æ—¶å¼€å¥– (ç½‘é¡µæå–æ¨¡å¼) - è½®æ¬¡: $i - $(date -d '+8 hours' '+%H:%M:%S')"
            
            # 1. æŠ“å–é¦–é¡µ HTML
            curl -sL "https://www.damacai.com.my/" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
              -o temp.html

            # 2. ä» HTML ç»“æ„ä¸­ç²¾ç¡®æå–å·ç  (é€‚é… 3+3D é¡µé¢æ ‡ç­¾)
            # ä½¿ç”¨ grep å’Œ sed è¿‡æ»¤å‡ºå¥–å·
            P1=$(grep -oP '(?<=p1-number">)[^<]+' temp.html | head -1 || echo "----")
            P2=$(grep -oP '(?<=p2-number">)[^<]+' temp.html | head -1 || echo "----")
            P3=$(grep -oP '(?<=p3-number">)[^<]+' temp.html | head -1 || echo "----")
            DRAWNO=$(grep -oP '(?<=draw-no">)[^<]+' temp.html | head -1 || echo "Pending")

            # 3. ç”Ÿæˆ JSON æ–‡ä»¶
            echo "{\"drawNo\":\"$DRAWNO\", \"p1\":\"$P1\", \"p2\":\"$P2\", \"p3\":\"$P3\"}" > data.json
            
            # è°ƒè¯•è¾“å‡º
            echo "å½“å‰æå–ç»“æœ: $DRAWNO | $P1 | $P2 | $P3"

            # 4. åªæœ‰å½“æŠ“å–åˆ°æœ‰æ•ˆæœŸå·ä¸”å†…å®¹å˜åŒ–æ—¶æ‰æäº¤
            if [ "$DRAWNO" != "Pending" ]; then
              git add data.json
              if git commit -m "Live Update: $(date -d '+8 hours' '+%H:%M:%S')"; then
                git push
                echo "âœ… æ•°æ®å·²æ›´æ–°è‡³ä»“åº“ï¼"
              else
                echo "ğŸ˜´ å·ç æ— å˜åŒ–ã€‚"
              fi
            else
              echo "âš ï¸ ç½‘é¡µå°šæœªæ›´æ–°æœŸå·ï¼Œè¯·ç¨åã€‚"
            fi
            
            echo "ç­‰å¾… 60 ç§’..."
            sleep 60
          done
