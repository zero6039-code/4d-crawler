name: Real-time 4D Scraper

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start 60-Minute Loop Scraper
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          for i in {1..60}
          do
            echo "------------------------------------------"
            echo "è½®æ¬¡: $i - æ­£åœ¨ä½¿ç”¨ LiveDraw åè®®åŒæ­¥..."
            
            # ç›´æ¥æŠ“å–ä½ å‘ç°çš„é»„é‡‘æ¥å£ï¼Œä½†å¸¦ä¸Šå…¨å¥—èº«ä»½å¤´
            curl -sL "https://livedraw.damacai.com.my/DrawResult.json" \
              -H "Accept: application/json, text/plain, */*" \
              -H "Origin: https://livedraw.damacai.com.my" \
              -H "Referer: https://livedraw.damacai.com.my/" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
              -o data.json

            # éªŒè¯æŠ“å–æ˜¯å¦æˆåŠŸ (æ£€æŸ¥æ˜¯å¦æœ‰æ•°å­—ï¼Œå“ªæ€•æ˜¯æœŸå·)
            if grep -qE "[0-9]" data.json; then
              # æ‰“å°å‰50ä¸ªå­—ç¬¦åˆ°æ—¥å¿—ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±èƒ½çœ‹å‡ºå¯¹ä¸å¯¹
              echo "æŠ“å–æˆåŠŸï¼æ•°æ®é¢„è§ˆ: $(head -c 60 data.json)"
              
              git add data.json
              if git commit -m "Live Sync: $(date -d '+8 hours' '+%H:%M:%S')"; then
                git push
                echo "âœ… å·ç å·²åŒæ­¥åˆ°ä»“åº“ï¼"
              else
                echo "ğŸ˜´ å·ç æ²¡å˜ï¼Œç­‰å¾…ä¸‹ä¸€åˆ†é’Ÿã€‚"
              fi
            else
              echo "âš ï¸ æŠ“å–å¤±è´¥ã€‚æœåŠ¡å™¨è¿”å›: $(cat data.json)"
              # å¤‡ç”¨æ–¹æ¡ˆï¼šæŠ“å–ä¸»ç«™å¤‡ç”¨ API
              echo "å¯åŠ¨å¤‡ç”¨ API..."
              curl -sL "https://www.damacai.com.my/callpassresult?pastdate=$(date -d '+8 hours' +%Y%m%d)" -o data.json
            fi
            
            sleep 60
          done
