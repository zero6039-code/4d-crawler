const axios = require('axios');
const cheerio = require('cheerio');
const fs = require('fs');

// ---------- é…ç½® ----------
const TARGETS = {
  damacai: 'https://livedraw.damacai.com.my/',   // è¯·æ›¿æ¢ä¸ºçœŸå®ž URL
  magnum: 'https://www.magnum4d.my/en/4d-results',       // è¯·æ›¿æ¢ä¸ºçœŸå®ž URL
  // å¯ç»§ç»­æ·»åŠ å…¶ä»–å…¬å¸
};

// æ¨¡æ‹Ÿæµè§ˆå™¨çš„è¯·æ±‚å¤´
const HEADERS = {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
};

// ---------- æŠ“å–å•ä¸ªå…¬å¸çš„å‡½æ•° ----------
async function fetchCompany(url, companyName) {
  console.log(`\n===== å¼€å§‹æŠ“å– ${companyName} =====`);
  try {
    // å‘é€è¯·æ±‚
    console.log(`è¯·æ±‚ URL: ${url}`);
    const response = await axios.get(url, { headers: HEADERS, timeout: 10000 });
    console.log(`è¯·æ±‚æˆåŠŸï¼ŒçŠ¶æ€ç : ${response.status}`);

    // åŠ è½½ HTML
    const $ = cheerio.load(response.data);
    
    // æ‰“å°ä¸€å°æ®µ HTML ä»¥ç¡®è®¤å†…å®¹ï¼ˆå¯é€‰ï¼Œç”¨äºŽè°ƒè¯•ï¼‰
    // console.log('HTML ç‰‡æ®µ:', $('body').html().substring(0, 500));

    // --- æ ¹æ®å®žé™…ç½‘é¡µç»“æž„è°ƒæ•´ä»¥ä¸‹é€‰æ‹©å™¨ ---
    // ç¤ºä¾‹é€‰æ‹©å™¨ï¼ˆè¯·åŠ¡å¿…ä¿®æ”¹ä¸ºæ­£ç¡®çš„ç±»å/IDï¼‰
    const first = $('.prize-first .number').text().trim() || '';
    const second = $('.prize-second .number').text().trim() || '';
    const third = $('.prize-third .number').text().trim() || '';

    // ç‰¹åˆ«å¥–åˆ—è¡¨ï¼ˆå‡è®¾æ¯ä¸ªå¥–é¡¹éƒ½åœ¨ .special-item ä¸­ï¼‰
    const special = [];
    $('.special-item').each((i, el) => {
      const num = $(el).text().trim();
      if (num) special.push(num);
    });

    // å®‰æ…°å¥–åˆ—è¡¨
    const consolation = [];
    $('.consolation-item').each((i, el) => {
      const num = $(el).text().trim();
      if (num) consolation.push(num);
    });

    // å¼€å¥–ä¿¡æ¯ï¼ˆå¦‚æ—¥æœŸã€æœŸå·ï¼‰
    const drawInfo = $('.draw-info').text().trim() || '';

    console.log(`è§£æžç»“æžœï¼š1st="${first}", 2nd="${second}", 3rd="${third}"`);
    console.log(`ç‰¹åˆ«å¥–æ•°é‡: ${special.length}, å®‰æ…°å¥–æ•°é‡: ${consolation.length}`);

    return {
      '1st': first,
      '2nd': second,
      '3rd': third,
      special,
      consolation,
      draw_info: drawInfo
    };
  } catch (err) {
    console.error(`âŒ æŠ“å– ${companyName} æ—¶å‡ºé”™:`, err.message);
    // è¿”å›žç©ºæ•°æ®ï¼Œé¿å…æ•´ä¸ªè„šæœ¬å´©æºƒ
    return {
      '1st': '',
      '2nd': '',
      '3rd': '',
      special: [],
      consolation: [],
      draw_info: ''
    };
  }
}

// ---------- ä¸»å‡½æ•° ----------
async function fetchAll() {
  console.log('ðŸš€ å¼€å§‹æŠ“å–æ‰€æœ‰å…¬å¸æ•°æ®...');
  const results = {};

  for (const [key, url] of Object.entries(TARGETS)) {
    results[key] = await fetchCompany(url, key);
    // æ·»åŠ å»¶æ—¶ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
    await new Promise(resolve => setTimeout(resolve, 2000));
  }

  // æž„é€ è¾“å‡º JSONï¼ˆç»“æž„ä¸Žå‰ç«¯ä¸€è‡´ï¼‰
  const output = {
    draw_date: new Date().toLocaleString('en-GB', {
      weekday: 'short',
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    }).replace(/\//g, '/'),  // ä¾‹å¦‚ "Wed, 25/02/2026"
    global_draw_no: 'éœ€ä»ŽæŸå¤„èŽ·å–æˆ–æš‚æ—¶ç•™ç©º', // æ‚¨å¯ä»¥ä»Žç½‘é¡µä¸­æå–æœŸå·
    results
  };

  // å†™å…¥æ–‡ä»¶
  fs.writeFileSync('docs/data.json', JSON.stringify(output, null, 2));
  console.log('\nâœ… æ•°æ®å·²å†™å…¥ docs/data.json');
}

// æ‰§è¡Œ
fetchAll().catch(err => {
  console.error('è„šæœ¬æ‰§è¡Œå¤±è´¥:', err);
  process.exit(1);
});
