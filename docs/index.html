<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D æˆç»© Malaysia Â· å®æ—¶æ›´æ–°</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { background: #f0f2f5; padding: 15px 10px; }
        .container { max-width: 1300px; margin: 0 auto; }
        h1 { font-size: 1.8rem; font-weight: 700; text-align: center; color: #1e2a3a; margin-bottom: 6px; background: linear-gradient(135deg, #0b1c2f, #2c3e50); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* ğŸ”§ ä¿®æ”¹ï¼šé¡¶éƒ¨åªä¿ç•™åˆ·æ–°æŒ‰é’® */
        .draw-info { background: #ffffffcc; backdrop-filter: blur(4px); border-radius: 40px; padding: 8px 16px; text-align: center; display: inline-block; margin: 0 auto 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); font-weight: 500; color: #2c3e50; border: 1px solid rgba(255,255,255,0.8); left: 50%; position: relative; transform: translateX(-50%); display: flex; align-items: center; gap: 10px; }
        
        .companies-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .company-section { background: white; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,20,30,0.1); margin-bottom: 0; padding: 14px 12px; border: 1px solid rgba(255,255,255,0.5); transition: transform 0.15s ease; position: relative; }
        .company-section:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,0.12); }
        .company-section.loading { opacity: 0.6; pointer-events: none; }
        .company-section.error { border-color: #d32f2f; background: #ffebee; }
        .company-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .company-title { font-size: 1.6rem; font-weight: 800; padding-left: 4px; background: linear-gradient(145deg, #1e2b3a, #2b3d55); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
        .company-title::before { content: "ğŸ¯"; margin-right: 6px; font-size: 1.4rem; background: none; -webkit-text-fill-color: initial; }
        
        /* ğŸ”§ å†å²æŒ‰é’®æ ·å¼ */
        .history-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(102,126,234,0.3);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .history-btn.active {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
        
        /* ğŸ”§ ä¿®æ”¹ï¼šæœˆå†æ ·å¼ */
        .history-dropdown {
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 280px;
            z-index: 1000;
            border: 1px solid #e2e8f0;
            display: none;
            padding: 15px;
        }
        
        .history-dropdown.show {
            display: block;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .calendar-header h4 {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .calendar-nav {
            display: flex;
            gap: 5px;
        }
        
        .calendar-nav button {
            background: #f0f2f5;
            border: none;
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        
        .calendar-nav button:hover {
            background: #e2e8f0;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-size: 0.7rem;
            color: #7c8b9c;
            padding: 5px;
            font-weight: 500;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #f0f2f5;
        }
        
        .calendar-day.has-data {
            background: #e6f0ff;
            color: #3182ce;
            font-weight: 600;
        }
        
        .calendar-day.has-data:hover {
            background: #3182ce;
            color: white;
        }
        
        .calendar-day.selected {
            background: #667eea;
            color: white;
        }
        
        .calendar-day.today {
            border: 2px solid #667eea;
        }
        
        .calendar-day.empty {
            cursor: default;
            background: transparent;
        }
        
        .calendar-day .date-num {
            font-size: 0.85rem;
        }
        
        .calendar-day .draw-indicator {
            font-size: 0.6rem;
            color: #667eea;
            margin-top: 2px;
        }
        
        .calendar-day.has-data.selected .draw-indicator {
            color: white;
        }
        
        .calendar-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 0.75rem;
            color: #7c8b9c;
        }
        
        .draw-date { font-size: 0.9rem; color: #4a5568; margin-bottom: 10px; padding-left: 4px; font-weight: 500; }
        .prize-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 12px 0 16px; }
        .prize-card { background: #f8fafd; border-radius: 16px; padding: 10px 12px; flex: 1 1 90px; min-width: 80px; text-align: center; box-shadow: inset 0 1px 4px #ffffff, 0 5px 10px rgba(0,0,0,0.04); border: 1px solid #e9ecf0; }
        .prize-card .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6b7a; font-weight: 500; margin-bottom: 4px; }
        .prize-card .number { font-size: 1.7rem; font-weight: 800; color: #c62828; line-height: 1.2; text-shadow: 2px 2px 0 rgba(198,40,40,0.1); font-family: 'Courier New', monospace; }
        .subsection { margin-top: 16px; background: #f9fbfd; border-radius: 16px; padding: 12px 10px; border: 1px solid #e2e8f0; }
        .subsection-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 4px; color: #1e2f3e; }
        .subsection-title::before { content: "âœ¨"; font-size: 1.2rem; }
        .number-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; }
        .number-item { background: #ffffff; padding: 6px 10px; border-radius: 28px; font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: 600; color: #0b2a41; box-shadow: 0 3px 8px rgba(0,0,0,0.03); border: 1px solid #d4deec; min-width: 50px; text-align: center; transition: all 0.1s; white-space: pre-line; line-height: 1.4; }
        .number-item:hover { background: #e6f0ff; border-color: #8a9cb0; }
        .custom-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.9rem; }
        .custom-table th { background: #e2e8f0; padding: 8px 4px; text-align: center; font-weight: 600; color: #2d3748; border: 1px solid #cbd5e0; }
        .custom-table td { padding: 6px 4px; text-align: center; border: 1px solid #cbd5e0; background: white; }
        .custom-table .alt-number { color: #3182ce; font-weight: 500; }
        .group-subtitle { font-size: 0.95rem; font-weight: 600; margin: 8px 0 4px 0; color: #2c3e50; width: 100%; }
        footer { text-align: center; margin-top: 30px; color: #7c8b9c; font-size: 0.8rem; border-top: 1px solid #dbe1ea; padding-top: 16px; }
        @media (max-width: 900px) { .companies-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .companies-grid { grid-template-columns: 1fr; } .company-title { font-size: 1.5rem; } .prize-card .number { font-size: 1.6rem; } .number-item { font-size: 1.0rem; padding: 5px 8px; min-width: 45px; } }
        .company-section[data-company="damacai"] .company-title { background: linear-gradient(145deg, #1e5620, #2a7a2d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .company-section[data-company="magnum"] .company-title { background: linear-gradient(145deg, #aa4a1e, #c95f2a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .company-section[data-company="toto"] .company-title { background: linear-gradient(145deg, #b71c1c, #d32f2f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(49,130,206,0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(49,130,206,0.4);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-btn.refreshing {
            animation: pulse 0.8s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-indicator.success { background: #48bb78; }
        .status-indicator.error { background: #f56565; }
        .status-indicator.loading { background: #ecc94b; animation: blink 1s infinite; }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‡²ğŸ‡¾ 4D RESULT MALAYSIA</h1>
        
        <!-- ğŸ”§ ä¿®æ”¹ï¼šåªä¿ç•™åˆ·æ–°æŒ‰é’® -->
        <div class="draw-info">
            <button class="refresh-btn" id="refresh-btn" onclick="forceRefresh()">
                <span>ğŸ”„</span> åˆ·æ–°
            </button>
        </div>

        <div id="companies-grid" class="companies-grid">
            <p style="text-align: center; grid-column: 1/-1; color: #666;">ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>

        <footer>
            âš ï¸ æ•°æ®ä»…ä¾›å‚è€ƒï¼Œè¯·ä»¥å®˜æ–¹å…¬å‘Šä¸ºå‡†ã€‚<br>
            <span id="status-text">
                <span class="status-indicator loading"></span>æ­£åœ¨åŠ è½½...
            </span>
            <br>
            æ›´æ–°äº <span id="update-time">-</span>
        </footer>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const COMPANY_LIST = [
            'damacai', 'magnum', 'toto', 'singapore', 'damacai_1p3d',
            'sandakan', 'sarawak_cashsweep', 'sabah', 'sabah_lotto',
            'sportstoto_fireball', 'grand_dragon', 'singapore_toto',
            'sportstoto_lotto', 'magnum_jackpot_gold', 'sportstoto_5d',
            'sportstoto_6d', 'magnum_life'
        ];

        const HISTORY_COMPANY_LIST = ['damacai', 'magnum', 'toto'];

        const NAME_MAP = {
            'sabah_lotto': 'SABAH LOTTO',
            'sportstoto_fireball': 'SPORTSTOTO FIREBALL',
            'sportstoto_5d': 'SPORTSTOTO 5D',
            'sportstoto_6d': 'SPORTSTOTO 6D',
            'sportstoto_lotto': 'SPORTSTOTO LOTTO',
            'singapore_toto': 'SINGAPORE TOTO',
            'magnum_jackpot_gold': 'MAGNUM JACKPOT GOLD',
            'magnum_life': 'MAGNUM LIFE',
            'grand_dragon': 'GRAND DRAGON',
            'singapore': 'SINGAPORE 4D',
            'damacai_1p3d': 'DAMACAI 1+3D',
            'sarawak_cashsweep': 'SARAWAK CASHSWEEP'
        };

        // ğŸ”§ å†å²æ•°æ®ç›¸å…³
        let historyDataMap = {};
        let selectedCompany = null;
        let selectedDrawIndex = null;
        let currentCalendarMonth = new Date();
        let requestCounter = 0;

        // ==================== å†å²æ•°æ®åŠŸèƒ½ ====================
        function toggleHistoryDropdown(companyKey) {
            const dropdown = document.getElementById(`history-dropdown-${companyKey}`);
            const btn = document.getElementById(`history-btn-${companyKey}`);
            
            // å…³é—­å…¶ä»–å…¬å¸çš„ä¸‹æ‹‰èœå•
            document.querySelectorAll('.history-dropdown').forEach(d => {
                if (d.id !== `history-dropdown-${companyKey}`) {
                    d.classList.remove('show');
                }
            });
            document.querySelectorAll('.history-btn').forEach(b => {
                if (b.id !== `history-btn-${companyKey}`) {
                    b.classList.remove('active');
                }
            });
            
            dropdown.classList.toggle('show');
            btn.classList.toggle('active');
            
            // æ‰“å¼€æ—¶æ¸²æŸ“æœˆå†
            if (dropdown.classList.contains('show')) {
                renderCalendar(companyKey);
            }
        }

        async function loadCompanyHistory(companyKey) {
            try {
                const response = await fetch(`data/${companyKey}_all.json?t=${Date.now()}`, {
                    cache: 'no-store'
                });
                
                if (response.ok) {
                    historyDataMap[companyKey] = await response.json();
                }
            } catch (err) {
                console.log(`${companyKey} å†å²æ•°æ®åŠ è½½å¤±è´¥:`, err);
            }
        }

        // ğŸ”§ æ¸²æŸ“æœˆå†
        function renderCalendar(companyKey) {
            const content = document.getElementById(`history-dropdown-content-${companyKey}`);
            const data = historyDataMap[companyKey];
            
            if (!data || data.length === 0) {
                content.innerHTML = '<div style="padding: 20px; text-align: center; color: #7c8b9c;">æš‚æ— å†å²æ•°æ®</div>';
                return;
            }
            
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // åˆ›å»ºæœ‰æ•°æ®çš„æ—¥æœŸæ˜ å°„
            const dataMap = {};
            data.forEach((item, index) => {
                const dateKey = item.draw_date;
                if (dateKey && dateKey !== '----') {
                    dataMap[dateKey] = index;
                }
            });
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            const today = new Date();
            const todayStr = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
            
            // ç”Ÿæˆæœˆå† HTML
            let html = `
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button onclick="prevMonth('${companyKey}')">â—€</button>
                    </div>
                    <h4>${monthNames[month]} ${year}</h4>
                    <div class="calendar-nav">
                        <button onclick="nextMonth('${companyKey}')">â–¶</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
            `;
            
            // ç©ºç™½æ—¥æœŸ
            for (let i = 0; i < startDay; i++) {
                html += `<div class="calendar-day empty"></div>`;
            }
            
            // å®é™…æ—¥æœŸ
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${String(day).padStart(2, '0')}-${String(month + 1).padStart(2, '0')}-${year}`;
                const hasData = dataMap[dateStr] !== undefined;
                const isToday = dateStr === todayStr;
                const isSelected = selectedCompany === companyKey && selectedDrawIndex === dataMap[dateStr];
                
                let classes = 'calendar-day';
                if (hasData) classes += ' has-data';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                
                const clickAction = hasData ? `onclick="selectHistoryDraw('${companyKey}', ${dataMap[dateStr]})"` : '';
                
                html += `
                    <div class="${classes}" ${clickAction}>
                        <span class="date-num">${day}</span>
                        ${hasData ? '<span class="draw-indicator">ğŸ“Š</span>' : ''}
                    </div>
                `;
            }
            
            html += `
                </div>
                <div class="calendar-footer">
                    ğŸ“Š æœ‰å¼€å¥–æ•°æ® &nbsp;|&nbsp; ç‚¹å‡»é€‰æ‹©æ—¥æœŸ
                </div>
            `;
            
            content.innerHTML = html;
        }

        function prevMonth(companyKey) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
            renderCalendar(companyKey);
        }

        function nextMonth(companyKey) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
            renderCalendar(companyKey);
        }

        function selectHistoryDraw(companyKey, index) {
            selectedCompany = companyKey;
            selectedDrawIndex = index;
            
            const data = historyDataMap[companyKey][index];
            if (!data) return;
            
            // å…³é—­ä¸‹æ‹‰èœå•
            document.getElementById(`history-dropdown-${companyKey}`).classList.remove('show');
            document.getElementById(`history-btn-${companyKey}`).classList.remove('active');
            
            // æ›´æ–°å…¬å¸å¡ç‰‡æ˜¾ç¤º
            updateCompanyCard(companyKey, data);
        }

        function updateCompanyCard(companyKey, data) {
            const section = document.querySelector(`.company-section[data-company="${companyKey}"]`);
            if (!section) return;
            
            // æ›´æ–°å¼€å¥–ä¿¡æ¯
            section.querySelector('.draw-date')?.remove();
            
            if (data.draw_info) {
                const drawDateDiv = document.createElement('div');
                drawDateDiv.className = 'draw-date';
                drawDateDiv.innerText = data.draw_info;
                const prizeGrid = section.querySelector('.prize-grid');
                if (prizeGrid) {
                    section.insertBefore(drawDateDiv, prizeGrid);
                }
            }
            
            // æ›´æ–°å¥–é¡¹å·ç 
            const prizeCards = section.querySelectorAll('.prize-card .number');
            if (prizeCards.length >= 3) {
                prizeCards[0].innerText = data['1st'] || '----';
                prizeCards[1].innerText = data['2nd'] || '----';
                prizeCards[2].innerText = data['3rd'] || '----';
            }
            
            // æ›´æ–°ç‰¹åˆ«å¥–å’Œå®‰æ…°å¥–
            const subsections = section.querySelectorAll('.subsection');
            if (subsections.length >= 2) {
                const specialList = subsections[0]?.querySelectorAll('.number-item');
                if (specialList) {
                    data.special?.forEach((num, i) => {
                        if (specialList[i]) specialList[i].innerText = num || '----';
                    });
                }
                
                const consolationList = subsections[1]?.querySelectorAll('.number-item');
                if (consolationList) {
                    data.consolation?.forEach((num, i) => {
                        if (consolationList[i]) consolationList[i].innerText = num || '----';
                    });
                }
            }
            
            // é‡æ–°æ¸²æŸ“æœˆå†ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderCalendar(companyKey);
        }

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadCompanyData(companyKey) {
            const retryCount = 3;
            const retryDelay = 1000;
            
            for (let i = 0; i < retryCount; i++) {
                try {
                    const cacheBuster = `?t=${Date.now()}&r=${Math.random()}&c=${++requestCounter}`;
                    const url = `data/${companyKey}.json${cacheBuster}`;
                    
                    const res = await fetch(url, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0',
                            'If-Modified-Since': 'Mon, 01 Jan 1990 00:00:00 GMT'
                        }
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        return { success: true, data };
                    }
                    
                    if (i < retryCount - 1) {
                        await sleep(retryDelay * (i + 1));
                    }
                } catch (err) {
                    console.warn(`${companyKey} è¯·æ±‚å¤±è´¥ (å°è¯• ${i + 1}/${retryCount})`, err);
                    if (i < retryCount - 1) {
                        await sleep(retryDelay * (i + 1));
                    }
                }
            }
            
            return { success: false, data: getPlaceholderData(companyKey) };
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getPlaceholderData(companyKey) {
            return {
                "1st": "----",
                "2nd": "----",
                "3rd": "----",
                "special": Array(10).fill("----"),
                "consolation": Array(10).fill("----"),
                "draw_info": "ç­‰å¾…æ›´æ–°",
                "draw_date": "----",
                "global_draw_no": "----"
            };
        }

        async function loadAllCompanies() {
            const grid = document.getElementById('companies-grid');
            const refreshBtn = document.getElementById('refresh-btn');
            const statusText = document.getElementById('status-text');
            
            if (refreshBtn) refreshBtn.classList.add('refreshing');
            if (statusText) statusText.innerHTML = '<span class="status-indicator loading"></span>æ­£åœ¨åŠ è½½...';
            
            try {
                // å…ˆåŠ è½½æ”¯æŒå†å²æ•°æ®çš„å…¬å¸
                for (const company of HISTORY_COMPANY_LIST) {
                    await loadCompanyHistory(company);
                }
                
                const promises = COMPANY_LIST.map(company => 
                    loadCompanyData(company).then(result => ({ company, ...result }))
                );
                
                const results = await Promise.all(promises);
                
                const dataMap = {};
                results.forEach(({ company, success, data }) => {
                    dataMap[company] = data;
                    
                    const section = document.querySelector(`.company-section[data-company="${company}"]`);
                    if (section) {
                        section.classList.remove('loading', 'error');
                        if (!success) section.classList.add('error');
                    }
                });

                grid.innerHTML = '';
                for (const [companyKey, companyData] of Object.entries(dataMap)) {
                    renderCompany(companyKey, companyData);
                }

                const successCount = results.filter(r => r.success).length;
                if (statusText) {
                    statusText.innerHTML = `<span class="status-indicator ${successCount === COMPANY_LIST.length ? 'success' : 'error'}"></span>${successCount}/${COMPANY_LIST.length} åŠ è½½æˆåŠŸ`;
                }
                
                document.getElementById('update-time').innerText = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Kuala_Lumpur' });
                
            } catch (err) {
                grid.innerHTML = `<p style="text-align: center; grid-column: 1/-1; color: #d32f2f;">âŒ åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
                if (statusText) statusText.innerHTML = '<span class="status-indicator error"></span>åŠ è½½å¤±è´¥';
            } finally {
                if (refreshBtn) refreshBtn.classList.remove('refreshing');
            }
        }

        function forceRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.classList.add('refreshing');
                refreshBtn.innerHTML = '<span>ğŸ”„</span> åˆ·æ–°ä¸­...';
            }
            
            if ('caches' in window) {
                caches.keys().then(names => names.forEach(name => caches.delete(name)));
            }
            
            historyDataMap = {};
            selectedCompany = null;
            selectedDrawIndex = null;
            currentCalendarMonth = new Date();
            
            loadAllCompanies().then(() => {
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<span>ğŸ”„</span> åˆ·æ–°';
                    refreshBtn.classList.remove('refreshing');
                }
            });
        }

        // ==================== æ¸²æŸ“å‡½æ•° ====================
        function renderCompany(companyKey, companyData) {
            const grid = document.getElementById('companies-grid');
            const section = document.createElement('div');
            section.className = 'company-section loading';
            section.setAttribute('data-company', companyKey);

            // å…¬å¸å¤´éƒ¨ï¼ˆæ ‡é¢˜ + å†å²æŒ‰é’®ï¼‰
            const headerDiv = document.createElement('div');
            headerDiv.className = 'company-header';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'company-title';
            const displayName = NAME_MAP[companyKey] || companyKey.replace(/_/g, ' ').toUpperCase();
            titleDiv.innerText = displayName;
            
            headerDiv.appendChild(titleDiv);
            
            // å†å²æŒ‰é’®ï¼ˆä»…æ”¯æŒçš„å…¬å¸æ˜¾ç¤ºï¼‰
            if (HISTORY_COMPANY_LIST.includes(companyKey)) {
                const historyBtn = document.createElement('button');
                historyBtn.className = 'history-btn';
                historyBtn.id = `history-btn-${companyKey}`;
                historyBtn.innerHTML = 'ğŸ“… å†å² <span class="arrow">â–¼</span>';
                historyBtn.onclick = () => toggleHistoryDropdown(companyKey);
                headerDiv.appendChild(historyBtn);
                
                // å†å²ä¸‹æ‹‰èœå•ï¼ˆæœˆå†ï¼‰
                const dropdown = document.createElement('div');
                dropdown.className = 'history-dropdown';
                dropdown.id = `history-dropdown-${companyKey}`;
                dropdown.innerHTML = `
                    <div id="history-dropdown-content-${companyKey}">
                        <div style="padding: 20px; text-align: center; color: #7c8b9c;">ğŸ”„ åŠ è½½...</div>
                    </div>
                `;
                section.appendChild(dropdown);
            }
            
            section.appendChild(headerDiv);

            if (companyData.draw_info && companyData.draw_info !== "----") {
                const drawDateDiv = document.createElement('div');
                drawDateDiv.className = 'draw-date';
                drawDateDiv.innerText = companyData.draw_info;
                section.appendChild(drawDateDiv);
            }

            if (companyKey === 'sportstoto_fireball') {
                const fbDiv = document.createElement('div');
                fbDiv.style.display = 'flex';
                fbDiv.style.justifyContent = 'center';
                fbDiv.style.marginBottom = '8px';
                fbDiv.innerHTML = `<div class="prize-card" style="flex:0 0 auto;padding:6px 16px;"><div class="label">Fireball</div><div class="number" style="font-size:2rem;">5</div></div>`;
                section.appendChild(fbDiv);
            }

            if (!companyData.type) {
                section.appendChild(createPrizeGrid(companyData));
                
                if (companyKey === 'sabah' && companyData['3d']) {
                    const title3d = document.createElement('div');
                    title3d.className = 'subsection-title';
                    title3d.style.marginTop = '8px';
                    title3d.style.fontSize = '1.0rem';
                    title3d.innerText = 'ğŸ¯ 3D Prize';
                    section.appendChild(title3d);
                    const prizeGrid3d = document.createElement('div');
                    prizeGrid3d.className = 'prize-grid';
                    prizeGrid3d.innerHTML = `
                        <div class="prize-card"><div class="label">1st Prize</div><div class="number">${companyData['3d']['1st'] || '----'}</div></div>
                        <div class="prize-card"><div class="label">2nd Prize</div><div class="number">${companyData['3d']['2nd'] || '----'}</div></div>
                        <div class="prize-card"><div class="label">3rd Prize</div><div class="number">${companyData['3d']['3rd'] || '----'}</div></div>
                    `;
                    section.appendChild(prizeGrid3d);
                }

                if (companyData.special && companyData.special.length > 0) {
                    section.appendChild(createNumberListSection(companyKey === 'sabah_lotto' ? 'Lotto 6/45' : 'ğŸ ç‰¹åˆ«å¥– (Special)', companyData.special));
                }
                if (companyData.consolation && companyData.consolation.length > 0 && companyKey !== 'sabah_lotto') {
                    section.appendChild(createNumberListSection('ğŸ˜Œ å®‰æ…°å¥– (Consolation)', companyData.consolation));
                }
            } else {
                renderSpecialType(section, companyKey, companyData);
            }

            grid.appendChild(section);
            
            setTimeout(() => section.classList.remove('loading'), 100);
        }

        function createPrizeGrid(companyData) {
            const prizeGrid = document.createElement('div');
            prizeGrid.className = 'prize-grid';
            prizeGrid.style.display = 'flex';
            prizeGrid.style.flexDirection = 'column';
            prizeGrid.style.alignItems = 'center';
            prizeGrid.style.gap = '8px';
            prizeGrid.style.margin = '12px 0 16px';
            
            const firstRow = document.createElement('div');
            firstRow.style.display = 'flex';
            firstRow.style.justifyContent = 'center';
            firstRow.style.width = '100%';
            firstRow.style.marginBottom = '4px';
            firstRow.innerHTML = `
                <div class="prize-card" style="flex: 0 0 220px; max-width: 220px; min-width: 180px;">
                    <div class="label">1st Prize</div>
                    <div class="number">${companyData['1st'] || '----'}</div>
                </div>
            `;
            
            const secondRow = document.createElement('div');
            secondRow.style.display = 'flex';
            secondRow.style.justifyContent = 'center';
            secondRow.style.gap = '8px';
            secondRow.style.width = '100%';
            secondRow.innerHTML = `
                <div class="prize-card" style="flex: 1; min-width: 90px; max-width: 150px;">
                    <div class="label">2nd Prize</div>
                    <div class="number">${companyData['2nd'] || '----'}</div>
                </div>
                <div class="prize-card" style="flex: 1; min-width: 90px; max-width: 150px;">
                    <div class="label">3rd Prize</div>
                    <div class="number">${companyData['3rd'] || '----'}</div>
                </div>
            `;
            
            prizeGrid.appendChild(firstRow);
            prizeGrid.appendChild(secondRow);
            
            return prizeGrid;
        }

        function createNumberListSection(title, numbers) {
            const section = document.createElement('div');
            section.className = 'subsection';
            const titleDiv = document.createElement('div');
            titleDiv.className = 'subsection-title';
            titleDiv.innerText = title;
            section.appendChild(titleDiv);
            const listDiv = document.createElement('div');
            listDiv.className = 'number-list';
            numbers.forEach(num => {
                const span = document.createElement('span');
                span.className = 'number-item' + (num === '' || num === "----" ? ' empty-item' : '');
                span.innerText = num || 'â€”';
                listDiv.appendChild(span);
            });
            section.appendChild(listDiv);
            return section;
        }

        function renderSpecialType(section, companyKey, data) {
            switch (data.type) {
                case 'fireball': renderFireball(section, data); break;
                case 'singapore_toto': renderSingaporeToto(section, data); break;
                case 'lotto': renderSportstotoLotto(section, data); break;
                case 'jackpot_gold': renderMagnumJackpotGold(section, data); break;
                case '5d_table': render5DTable(section, data); break;
                case '6d_table': render6DTable(section, data); break;
                case 'magnum_life': renderMagnumLife(section, data); break;
            }
        }

        function renderFireball(section, data) {
            const prizes = [
                { title: 'First Prize (RM500)', items: data.first_prize },
                { title: 'Second Prize (RM200)', items: data.second_prize },
                { title: 'Third Prize (RM100)', items: data.third_prize }
            ];
            prizes.forEach(p => {
                const title = document.createElement('div');
                title.className = 'subsection-title';
                title.style.marginTop = '8px';
                title.innerText = p.title;
                section.appendChild(title);
                const list = document.createElement('div');
                list.className = 'number-list';
                list.style.marginBottom = '12px';
                p.items.forEach(num => {
                    const span = document.createElement('span');
                    span.className = 'number-item';
                    span.innerText = num;
                    list.appendChild(span);
                });
                section.appendChild(list);
            });
            section.appendChild(createNumberListSection('ğŸ’° Special (RM30)', data.special));
            section.appendChild(createNumberListSection('ğŸ’µ Consolation (RM10)', data.consolation));
        }

        function renderSingaporeToto(section, data) {
            section.appendChild(createNumberListSection('å¼€å¥–å·ç ', data.winning_numbers));
            const tableDiv = document.createElement('div');
            tableDiv.className = 'subsection';
            tableDiv.innerHTML = '<div class="subsection-title">å¥–é‡‘åˆ†é…</div>';
            const table = document.createElement('table');
            table.className = 'custom-table';
            table.innerHTML = '<tr><th>Prize Group</th><th>Share Amount (Each)</th><th>No. of Winning Shares</th></tr>';
            data.prize_table.forEach(row => {
                table.innerHTML += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td></tr>`;
            });
            tableDiv.appendChild(table);
            section.appendChild(tableDiv);
        }

        function renderSportstotoLotto(section, data) {
            const lottoSection = document.createElement('div');
            lottoSection.className = 'subsection';
            lottoSection.innerHTML = '<div class="subsection-title">ä¹é€å·ç </div>';
            const groups = [
                { title: 'Star Toto 6/50', items: data.star },
                { title: 'Power Toto 6/55', items: data.power },
                { title: 'Supreme Toto 6/58', items: data.supreme }
            ];
            groups.forEach(g => {
                const sub = document.createElement('div');
                sub.className = 'group-subtitle';
                sub.innerText = g.title;
                lottoSection.appendChild(sub);
                const list = document.createElement('div');
                list.className = 'number-list';
                g.items.forEach(num => {
                    const span = document.createElement('span');
                    span.className = 'number-item';
                    span.innerText = num;
                    list.appendChild(span);
                });
                lottoSection.appendChild(list);
            });
            section.appendChild(lottoSection);

            const jpSection = document.createElement('div');
            jpSection.className = 'subsection';
            jpSection.innerHTML = '<div class="subsection-title">ğŸ’° Jackpot</div>';
            const jpList = document.createElement('div');
            jpList.className = 'number-list';
            data.jackpots.forEach(jp => {
                const span = document.createElement('span');
                span.className = 'number-item';
                span.innerText = jp;
                jpList.appendChild(span);
            });
            jpSection.appendChild(jpList);
            section.appendChild(jpSection);
        }

        function renderMagnumJackpotGold(section, data) {
            section.appendChild(createNumberListSection('Jackpot 1', data.jackpot1));
            const jp2Section = document.createElement('div');
            jp2Section.className = 'subsection';
            jp2Section.innerHTML = '<div class="subsection-title">Jackpot 2</div>';
            data.jackpot2_options.forEach((opt, idx) => {
                const list = document.createElement('div');
                list.className = 'number-list';
                list.style.marginBottom = '8px';
                opt.forEach(part => {
                    const span = document.createElement('span');
                    span.className = 'number-item';
                    span.innerText = part;
                    list.appendChild(span);
                });
                jp2Section.appendChild(list);
            });
            section.appendChild(jp2Section);

            const estDiv = document.createElement('div');
            estDiv.className = 'subsection';
            estDiv.innerHTML = '<div class="subsection-title">Estimated Amount</div>';
            data.estimated.forEach(est => {
                const box = document.createElement('div');
                box.style.background = '#e6f0ff';
                box.style.borderRadius = '28px';
                box.style.padding = '8px 12px';
                box.style.marginBottom = '4px';
                box.style.fontSize = '1rem';
                box.style.fontWeight = '600';
                box.style.color = '#1e40af';
                box.style.border = '1px solid #a5b4fc';
                box.style.textAlign = 'center';
                box.innerText = est;
                estDiv.appendChild(box);
            });
            section.appendChild(estDiv);
        }

        function render5DTable(section, data) {
            const table = document.createElement('table');
            table.className = 'custom-table';
            data.data.forEach(row => {
                table.innerHTML += `<tr><td style="font-weight:600;">${row[0]}</td><td>${row[1]}</td></tr>`;
            });
            section.appendChild(table);
        }

        function render6DTable(section, data) {
            const table = document.createElement('table');
            table.className = 'custom-table';
            table.innerHTML = '<tr><th>å¥–é¡¹</th><th>ä¸»å·ç </th><th>OR</th></tr>';
            data.data.forEach(row => {
                table.innerHTML += `<tr><td>${row[0]}</td><td>${row[1]}</td><td class="alt-number">${row[2] || ''}</td></tr>`;
            });
            section.appendChild(table);
        }

        function renderMagnumLife(section, data) {
            section.appendChild(createNumberListSection('WINNING NUMBERS', data.winning));
            section.appendChild(createNumberListSection('BONUS NUMBERS', data.bonus));
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadAllCompanies();
            setInterval(loadAllCompanies, 60000);
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadAllCompanies();
            }
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.history-dropdown').forEach(dropdown => {
                if (dropdown && !dropdown.contains(e.target) && !e.target.classList.contains('history-btn')) {
                    dropdown.classList.remove('show');
                    dropdown.previousElementSibling?.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
