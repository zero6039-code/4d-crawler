// scripts/scraper/damacai.js
const fetch = require('node-fetch');
const fs = require('fs');
const path = require('path');

const defaultData = {
  draw_date: "----",
  global_draw_no: "----",
  "1st": "----",
  "2nd": "----",
  "3rd": "----",
  special: Array(10).fill("----"),
  consolation: Array(10).fill("----"),
  draw_info: "----"
};

async function fetchDamacaiResults() {
  try {
    console.log('ðŸ”„ æ­¥éª¤ 1: èŽ·å–å¼€å¥–æ—¥æœŸåˆ—è¡¨...');
    
    const datesResponse = await fetch('https://www.damacai.com.my/ListPastResult', {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json'
      }
    });
    
    if (!datesResponse.ok) {
      throw new Error(`èŽ·å–æ—¥æœŸå¤±è´¥ï¼šHTTP ${datesResponse.status}`);
    }
    
    const datesData = await datesResponse.json();
    let drawDates = datesData.drawdate.trim().split(' ');
    
    // æŒ‰æ—¥æœŸé™åºæŽ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
    drawDates = drawDates.sort((a, b) => b.localeCompare(a));
    
    console.log(`ðŸ“… å‰ 5 ä¸ªæ—¥æœŸï¼š${drawDates.slice(0, 5).join(', ')}`);
    
    if (!drawDates || drawDates.length === 0) {
      throw new Error('æ²¡æœ‰èŽ·å–åˆ°å¼€å¥–æ—¥æœŸ');
    }
    
    const latestDate = drawDates[0];
    console.log(`ðŸ“… æœ€æ–°å¼€å¥–æ—¥æœŸï¼š${latestDate}`);
    
    console.log('ðŸ”„ æ­¥éª¤ 2: èŽ·å–ç»“æžœæ–‡ä»¶é“¾æŽ¥...');
    const linkResponse = await fetch(`https://www.damacai.com.my/callpassresult?pastdate=${latestDate}`, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json',
        'cookiesession': '363'
      }
    });
    
    if (!linkResponse.ok) {
      throw new Error(`èŽ·å–é“¾æŽ¥å¤±è´¥ï¼šHTTP ${linkResponse.status}`);
    }
    
    const linkData = await linkResponse.json();
    const resultUrl = linkData.link;
    
    if (!resultUrl) {
      throw new Error('æ²¡æœ‰èŽ·å–åˆ°ç»“æžœé“¾æŽ¥');
    }
    
    console.log(`ðŸ”— ç»“æžœé“¾æŽ¥ï¼š${resultUrl}`);
    
    console.log('ðŸ”„ æ­¥éª¤ 3: èŽ·å–å¼€å¥–æ•°æ®...');
    const resultResponse = await fetch(resultUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json'
      }
    });
    
    if (!resultResponse.ok) {
      throw new Error(`èŽ·å–æ•°æ®å¤±è´¥ï¼šHTTP ${resultResponse.status}`);
    }
    
    const resultData = await resultResponse.json();
    console.log('âœ… æ•°æ®èŽ·å–æˆåŠŸ');
    console.log('ðŸ“Š åŽŸå§‹æ•°æ®:', JSON.stringify(resultData, null, 2));
    
    return parseDamacaiData(resultData, latestDate);
    
  } catch (error) {
    console.error(`âŒ èŽ·å–å¤±è´¥ï¼š${error.message}`);
    return defaultData;
  }
}

function parseDamacaiData(data, drawDate) {
  const formattedDate = `${drawDate.substring(6,8)}-${drawDate.substring(4,6)}-${drawDate.substring(0,4)}`;
  
  // ðŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µåç§°
  // å¤´å¥–ã€äºŒå¥–ã€ä¸‰å¥–
  const firstPrize = data.p1HorseNo || data.FirstPrize || data.firstPrize || "----";
  const secondPrize = data.p2HorseNo || data.SecondPrize || data.secondPrize || "----";
  const thirdPrize = data.p3HorseNo || data.ThirdPrize || data.thirdPrize || "----";
  
  // ç‰¹åˆ«å¥– (starterList)
  let special = data.starterList || data.starterHorseList || data.Special || data.special || [];
  if (!Array.isArray(special)) special = [];
  
  // å®‰æ…°å¥– (consolidateList)
  let consolation = data.consolidateList || data.Consolation || data.consolation || [];
  if (!Array.isArray(consolation)) consolation = [];
  
  // ðŸ”§ è¿‡æ»¤æŽ‰ "-" å¹¶å¡«å……åˆ° 10 ä¸ª
  special = special.filter(s => s && s !== "-" && s !== "null").slice(0, 10);
  consolation = consolation.filter(c => c && c !== "-" && c !== "null").slice(0, 10);
  
  while (special.length < 10) special.push("----");
  while (consolation.length < 10) consolation.push("----");
  
  console.log('ðŸ“Š è§£æžåŽçš„å¤´å¥–:', firstPrize);
  console.log('ðŸ“Š è§£æžåŽçš„äºŒå¥–:', secondPrize);
  console.log('ðŸ“Š è§£æžåŽçš„ä¸‰å¥–:', thirdPrize);
  console.log('ðŸ“Š è§£æžåŽçš„ç‰¹åˆ«å¥–:', special);
  console.log('ðŸ“Š è§£æžåŽçš„å®‰æ…°å¥–:', consolation);
  
  return {
    draw_date: formattedDate,
    global_draw_no: data.drawNo || data.DrawNo || data.draw_no || "----",
    "1st": firstPrize,
    "2nd": secondPrize,
    "3rd": thirdPrize,
    special: special,
    consolation: consolation,
    draw_info: (data.drawNo || data.DrawNo || data.draw_no) 
      ? `(${getDayName(formattedDate)}) ${formattedDate} #${data.drawNo || data.DrawNo || data.draw_no}`
      : "----"
  };
}

function getDayName(dateStr) {
  const [day, month, year] = dateStr.split('-');
  const date = new Date(`${year}-${month}-${day}`);
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  return days[date.getDay()];
}

async function main() {
  console.log(`ðŸ”„ [${new Date().toLocaleString('zh-MY')}] å¼€å§‹æŠ“å– DAMACAI æ•°æ®...`);
  
  const results = await fetchDamacaiResults();
  
  const outputPath = path.join(__dirname, '../../docs/data/damacai.json');
  fs.writeFileSync(outputPath, JSON.stringify(results, null, 2));
  
  console.log(`âœ… [${new Date().toLocaleString('zh-MY')}] DAMACAI æ•°æ®å·²æ›´æ–°`);
  console.log('ðŸ“„ è¾“å‡ºæ–‡ä»¶:', outputPath);
  console.log('ðŸ“Š ç”Ÿæˆæ•°æ®:', JSON.stringify(results, null, 2));
}

main();
